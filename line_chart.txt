Option Explicit

Sub LineChart_Averages()

    Dim ws As Worksheet, outWS As Worksheet
    Dim rng As Range
    Dim firstCol As Long
    Dim lastRow As Long
    Dim r As Long, i As Long, c As Long
    Dim grp As String
    Dim grpList() As String
    Dim grpCount As Long
    Dim sums() As Double, cnts() As Long
    Dim ch As ChartObject
    Dim nVars As Long
    Dim v As Variant
    Dim found As Boolean
    Dim ar As Range, oneCol As Range
    Dim selCols As Range
    Dim colIndex As Long

    '===== selection: ONE OR MORE columns; allow disjoint =====
    If TypeName(Selection) <> "Range" Then
        MsgBox "Select at least ONE numeric column.", vbExclamation
        Exit Sub
    End If

    Set ws = ActiveSheet

    '----- build union of selected numeric columns, EXCLUDING column A (Parity) -----
    For Each ar In Selection.Areas
        For Each oneCol In ar.Columns
            If oneCol.Column <> 1 Then                    'skip Parity column A
                If selCols Is Nothing Then
                    Set selCols = oneCol
                Else
                    Set selCols = Union(selCols, oneCol)
                End If
            End If
        Next oneCol
    Next ar

    If selCols Is Nothing Then
        MsgBox "No numeric columns selected (Parity in column A is for grouping only).", vbExclamation
        Exit Sub
    End If

    nVars = selCols.Columns.count                         'numeric variables count

    'Group column is always A (Parity)
    firstCol = 1
    lastRow = ws.Cells(ws.Rows.count, firstCol).End(xlUp).row
    If lastRow < 2 Then
        MsgBox "Not enough data.", vbExclamation
        Exit Sub
    End If

    '===== collect unique groups from column A =====
    ReDim grpList(0 To lastRow - 2)
    grpCount = 0

    For r = 2 To lastRow
        grp = Trim(CStr(ws.Cells(r, firstCol).value))
        If grp <> "" Then
            found = False
            For i = 0 To grpCount - 1
                If grpList(i) = grp Then
                    found = True
                    Exit For
                End If
            Next i
            If Not found Then
                grpList(grpCount) = grp
                grpCount = grpCount + 1
            End If
        End If
    Next r

    If grpCount = 0 Then
        MsgBox "No valid groups found in column A.", vbExclamation
        Exit Sub
    End If

    ReDim Preserve grpList(0 To grpCount - 1)
    BubbleSortStrings grpList

    '===== sums and counts arrays =====
    ReDim sums(0 To grpCount - 1, 0 To nVars - 1)
    ReDim cnts(0 To grpCount - 1, 0 To nVars - 1)

    '===== accumulate sums and counts over selected numeric columns =====
    colIndex = 0
    For Each ar In selCols.Areas
        For c = 1 To ar.Columns.count
            For r = 2 To lastRow
                grp = Trim(CStr(ws.Cells(r, firstCol).value))
                v = ar.Columns(c).Cells(r - 1).value      'ar starts at row 1
                If grp <> "" Then
                    For i = 0 To grpCount - 1
                        If grpList(i) = grp Then
                            If isNumeric(v) And Not IsEmpty(v) And v <> "" Then
                                sums(i, colIndex) = sums(i, colIndex) + CDbl(v)
                                cnts(i, colIndex) = cnts(i, colIndex) + 1
                            End If
                            Exit For
                        End If
                    Next i
                End If
            Next r
            colIndex = colIndex + 1
        Next c
    Next ar

    '===== create/reset output sheet "linechart" =====
    Application.DisplayAlerts = False
    On Error Resume Next
    ThisWorkbook.Sheets("linechart").Delete
    On Error GoTo 0
    Application.DisplayAlerts = True

    Set outWS = ThisWorkbook.Sheets.Add
    outWS.Name = "linechart"

    '===== header row: first col blank, then groups =====
    outWS.Cells(1, 1).value = ""
    For i = 0 To grpCount - 1
        outWS.Cells(1, i + 2).value = grpList(i)
    Next i

    '===== row labels from selected numeric headers (Parity never appears) =====
    colIndex = 0
    For Each ar In selCols.Areas
        For c = 1 To ar.Columns.count
            outWS.Cells(colIndex + 2, 1).value = "Average of " & _
                ws.Cells(1, ar.Columns(c).Column).value
            colIndex = colIndex + 1
        Next c
    Next ar

    '===== fill averages (aligned with labels) =====
    For i = 0 To grpCount - 1
        For c = 0 To nVars - 1
            If cnts(i, c) > 0 Then
                outWS.Cells(c + 2, i + 2).value = sums(i, c) / cnts(i, c)
            Else
                outWS.Cells(c + 2, i + 2).value = ""
            End If
        Next c
    Next i

    outWS.Columns.AutoFit

    '===== create line chart from this table =====
    Set ch = outWS.ChartObjects.Add( _
                Left:=100, _
                Top:=outWS.Cells(nVars + 3, 1).Top, _
                width:=650, Height:=350)

    With ch.Chart
        .SetSourceData outWS.Range( _
            outWS.Cells(1, 1), _
            outWS.Cells(nVars + 1, grpCount + 1))
        .ChartType = xlLineMarkers
        .HasTitle = True
        .ChartTitle.Text = "Average of selected variables by " & ws.Cells(1, 1).value
        .HasLegend = True
        .Legend.Position = xlLegendPositionBottom
        .Axes(xlCategory).TickLabels.Orientation = 0
    End With

    outWS.Activate
    MsgBox "Average table and line chart created on sheet 'linechart'.", vbInformation

End Sub

'===== helper: bubble sort strings =====
Sub BubbleSortStrings(arr() As String)
    Dim i As Long, j As Long
    Dim temp As String
    For i = LBound(arr) To UBound(arr) - 1
        For j = i + 1 To UBound(arr)
            If arr(i) > arr(j) Then
                temp = arr(i)
                arr(i) = arr(j)
                arr(j) = temp
            End If
        Next j
    Next i
End Sub
