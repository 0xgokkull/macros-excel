Sub DoubleBar_Chart()

    Dim ws As Worksheet, outWS As Worksheet
    Dim rng As Range
    Dim lastRow As Long, r As Long, i As Long, j As Long
    Dim cat As String, grp As String
    Dim catList() As String, grpList() As String
    Dim catCount As Long, grpCount As Long
    Dim counts() As Long
    Dim ch As ChartObject
    
    ' ===== check selection =====
    If Selection.Columns.count <> 2 Or Selection.Areas.count > 1 Then
        MsgBox "Please select EXACTLY two columns:" & vbCrLf & _
               "• First column = categories (row headings, e.g. StudyGroup)" & vbCrLf & _
               "• Second column = groups (Male/Female, Group A/B, etc.)", vbExclamation
        Exit Sub
    End If
    
    Set rng = Selection
    lastRow = rng.Cells(rng.Rows.count, 1).End(xlUp).row
    If lastRow < 2 Then
        MsgBox "Not enough data.", vbExclamation
        Exit Sub
    End If
    
    Set rng = rng.Resize(lastRow, 2)
    Set ws = rng.Worksheet
    
    ' ===== collect unique categories (first column), then sort =====
    ReDim catList(0 To lastRow - 2)
    catCount = 0
    For r = 2 To lastRow
        cat = Trim(rng.Cells(r, 1).value & "")
        If cat <> "" Then
            If Not InArray(catList, catCount, cat) Then
                catList(catCount) = cat
                catCount = catCount + 1
            End If
        End If
    Next r
    If catCount = 0 Then
        MsgBox "No valid categories found.", vbExclamation
        Exit Sub
    End If
    ReDim Preserve catList(0 To catCount - 1)
    BubbleSort catList
    
    ' ===== collect unique groups (second column) =====
    ReDim grpList(0 To lastRow - 2)
    grpCount = 0
    For r = 2 To lastRow
        grp = Trim(rng.Cells(r, 2).value & "")
        If grp <> "" Then
            If Not InArray(grpList, grpCount, grp) Then
                grpList(grpCount) = grp
                grpCount = grpCount + 1
            End If
        End If
    Next r
    If grpCount = 0 Then
        MsgBox "No valid groups found.", vbExclamation
        Exit Sub
    End If
    ReDim Preserve grpList(0 To grpCount - 1)
    
    ' ===== count frequencies for each (category, group) =====
    ReDim counts(0 To catCount - 1, 0 To grpCount - 1)
    For r = 2 To lastRow
        cat = Trim(rng.Cells(r, 1).value & "")
        grp = Trim(rng.Cells(r, 2).value & "")
        If cat <> "" And grp <> "" Then
            For i = 0 To catCount - 1
                If catList(i) = cat Then
                    For j = 0 To grpCount - 1
                        If grpList(j) = grp Then
                            counts(i, j) = counts(i, j) + 1
                            Exit For
                        End If
                    Next j
                    Exit For
                End If
            Next i
        End If
    Next r
    
    ' ===== create / reset output sheet =====
    Application.DisplayAlerts = False
    On Error Resume Next
    ThisWorkbook.Sheets("Group Chart").Delete
    On Error GoTo 0
    Application.DisplayAlerts = True
    
    Set outWS = ThisWorkbook.Sheets.Add
    outWS.Name = "Group Chart"
    
    ' ===== write contingency table =====
    outWS.Cells(1, 1).value = rng.Cells(1, 1).value   ' first column header
    
    For j = 0 To grpCount - 1                         ' group headers
        outWS.Cells(1, j + 2).value = grpList(j)
    Next j
    outWS.Cells(1, grpCount + 2).value = "Grand Total"
    
    Dim rowTotal As Long
    For i = 0 To catCount - 1
        outWS.Cells(i + 2, 1).value = catList(i)
        rowTotal = 0
        For j = 0 To grpCount - 1
            outWS.Cells(i + 2, j + 2).value = counts(i, j)
            rowTotal = rowTotal + counts(i, j)
        Next j
        outWS.Cells(i + 2, grpCount + 2).value = rowTotal
    Next i
    
    outWS.Cells(catCount + 2, 1).value = "Grand Total"
    For j = 0 To grpCount - 1
        outWS.Cells(catCount + 2, j + 2).FormulaR1C1 = _
            "=SUM(R2C" & (j + 2) & ":R" & (catCount + 1) & "C" & (j + 2) & ")"
    Next j
    outWS.Cells(catCount + 2, grpCount + 2).FormulaR1C1 = _
        "=SUM(R2C" & (grpCount + 2) & ":R" & (catCount + 1) & "C" & (grpCount + 2) & ")"
    
    With outWS.Range("A1", outWS.Cells(1, grpCount + 2))
        .Font.Bold = True
        .Interior.Color = RGB(200, 200, 200)
    End With
    outWS.Columns.AutoFit
    
    ' ===== create grouped (clustered) column chart, thin bars, big gaps =====
    Set ch = outWS.ChartObjects.Add( _
                Left:=100, _
                Top:=outWS.Cells(catCount + 5, 1).Top, _
                width:=650, Height:=350)
    
    With ch.Chart
        .SetSourceData outWS.Range("A1", outWS.Cells(catCount + 1, grpCount + 1))
        .PlotBy = xlColumns
        .ChartType = xlColumnClustered
        
        ' geometry: more gap & thinner bars
        .ColumnGroups(1).Overlap = -40   ' big separation between bars in each pair
        .ColumnGroups(1).GapWidth = 220  ' thin bars and extra gap between categories
        
        .HasTitle = True
        .ChartTitle.Text = rng.Cells(1, 1).value & " by " & rng.Cells(1, 2).value
        .HasLegend = True
        .Legend.Position = xlLegendPositionBottom
        .ApplyDataLabels
        .Axes(xlCategory).TickLabels.Orientation = 0
    End With
    
    outWS.Activate
    MsgBox "Contingency table and grouped bar chart created.", vbInformation

End Sub

' ===== helper: membership in array =====
Function InArray(arr() As String, count As Long, val As String) As Boolean
    Dim i As Long
    For i = 0 To count - 1
        If arr(i) = val Then
            InArray = True
            Exit Function
        End If
    Next i
End Function

' ===== helper: bubble sort strings =====
Sub BubbleSort(arr() As String)
    Dim i As Long, j As Long
    Dim temp As String
    For i = 0 To UBound(arr) - 1
        For j = i + 1 To UBound(arr)
            If arr(i) > arr(j) Then
                temp = arr(i)
                arr(i) = arr(j)
                arr(j) = temp
            End If
        Next j
    Next i
End Sub